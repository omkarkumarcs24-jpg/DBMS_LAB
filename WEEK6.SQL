-- Additional Queries On Employee Database  (WEEK-6)...

-- 3rd
SELECT E1.ENAME AS Manager_Name
FROM EMPLOYEE E1
JOIN EMPLOYEE E2 ON E1.EMPNO = E2.MGR_NO
GROUP BY E1.EMPNO, E1.ENAME
HAVING COUNT(E2.EMPNO) = (
    SELECT MAX(emp_count)
    FROM (
        SELECT COUNT(*) AS emp_count
        FROM EMPLOYEE
        WHERE MGR_NO IS NOT NULL
        GROUP BY MGR_NO
    ) AS sub
);


-- 4th
SELECT DISTINCT m.ENAME AS Manager_Name
FROM EMPLOYEE m
JOIN EMPLOYEE E ON m.EMPNO = e.MGR_NO
GROUP BY m.EMPNO, m.ENAME, m.SAL
HAVING m.SAL > AVG(e.SAL);

-- 5th

SELECT DISTINCT e.ENAME AS Second_top_level_manager, d.DNAME AS Department_Name
FROM EMPLOYEE e
JOIN EMPLOYEE m ON e.MGR_NO = m.EMPNO
JOIN DEPT D ON e.DEPTNO = d.DEPTNO
WHERE m.MGR_NO IS NULL;

-- 6th

SELECT E.*
FROM EMPLOYEE E
JOIN INCENTIVES I ON E.EMPNO = I.EMPNO
WHERE I.INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
AND I.INCENTIVE_AMOUNT = (
    SELECT MAX(INCENTIVE_AMOUNT)
    FROM INCENTIVES
    WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
    AND INCENTIVE_AMOUNT < (
        SELECT MAX(INCENTIVE_AMOUNT)
        FROM INCENTIVES
        WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
    )
);

-- 7th 

SELECT e.ENAME AS Employee_Name, m.ENAME AS Manager_Name, d.DNAME AS Department
FROM EMPLOYEE e
JOIN EMPLOYEE m ON e.MGR_NO = m.EMPNO
JOIN DEPT d ON e.DEPTNO = d.DEPTNO
WHERE e.DEPTNO = m.DEPTNO;

